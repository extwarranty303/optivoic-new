<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upmarket Bijoux | Admin File Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f4f1ea;
            color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .admin-panel {
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 500px;
        }
        .admin-panel h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: #666;
        }
        select, input[type="file"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #1a1a1a;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #c5a47e;
        }
        #status-message {
            margin-top: 20px;
            font-size: 0.85rem;
            text-align: center;
            font-weight: 600;
        }
        .loading { color: #c5a47e; }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>

    <div class="admin-panel">
        <h2>Asset Manager</h2>
        
        <div class="form-group">
            <label for="product-select">1. Select Product to Update</label>
            <select id="product-select">
                <option value="">Loading products...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="spreadsheet-upload">2. Choose New File</label>
            <input type="file" id="spreadsheet-upload" accept=".xlsx, .xls, .csv, .pdf">
        </div>

        <div class="form-group">
            <label for="version-notes">3. Version Notes (Optional)</label>
            <input type="text" id="version-notes" placeholder="e.g., Added 2026 tax brackets">
        </div>

        <button onclick="handleAdminUpload()" id="upload-btn">Upload & Publish</button>
        
        <div id="status-message"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase (Using your existing keys)
        const supabaseUrl = 'https://okyrcukqkzikguoeunwc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9reXJjdWtxa3ppa2d1b2V1bndjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDQwODYsImV4cCI6MjA4NzQyMDA4Nn0.srgYP4MyL_M4RmS8SnG_wv_wKvCF1eaEQGdLFDXrfjY';
        const dbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        const statusDiv = document.getElementById('status-message');
        const uploadBtn = document.getElementById('upload-btn');

        // Automatically load products into the dropdown when the page opens
        async function loadProducts() {
            const { data, error } = await dbClient
                .from('products')
                .select('id, title')
                .eq('is_active', true);

            const select = document.getElementById('product-select');
            
            if (error) {
                console.error("Error loading products:", error);
                select.innerHTML = '<option value="">Error loading products</option>';
                return;
            }

            if (!data || data.length === 0) {
                select.innerHTML = '<option value="">No active products found in database</option>';
                return;
            }

            select.innerHTML = '<option value="">-- Select a Product --</option>';
            data.forEach(product => {
                select.innerHTML += `<option value="${product.id}">${product.title}</option>`;
            });
        }

        // The 3-Step Upload Engine
        async function handleAdminUpload() {
            const fileInput = document.getElementById('spreadsheet-upload');
            const productSelect = document.getElementById('product-select');
            const notesInput = document.getElementById('version-notes');
            
            if (!productSelect.value) {
                setStatus('Please select a product first.', 'error');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                setStatus('Please select a file to upload.', 'error');
                return;
            }

            const file = fileInput.files[0];
            const productId = productSelect.value;
            const originalFilename = file.name; 
            
            // Clean the filename and create a collision-proof UUID path
            const safeName = originalFilename.replace(/[^a-zA-Z0-9.\-_]/g, '_');
            const storagePath = `${Date.now()}-${Math.round(Math.random() * 1000)}-${safeName}`;

            try {
                uploadBtn.disabled = true;
                setStatus('Step 1: Uploading secure file to bucket...', 'loading');
                
                // 1. Upload to Supabase Storage
                const { data: storageData, error: storageError } = await dbClient.storage
                    .from('digital_products')
                    .upload(storagePath, file);

                if (storageError) throw storageError;

                setStatus('Step 2: Recording file metadata...', 'loading');

                // 2. Insert record into `files` table
                const { data: fileRecord, error: fileDbError } = await dbClient
                    .from('files')
                    .insert([{
                        product_id: productId,
                        storage_path: storagePath,
                        original_filename: originalFilename,
                        version_notes: notesInput.value || 'Routine update'
                    }])
                    .select('id')
                    .single();

                if (fileDbError) throw fileDbError;

                setStatus('Step 3: Linking file to storefront...', 'loading');

                // 3. Update the `products` table to point to this new file
                const { error: productUpdateError } = await dbClient
                    .from('products')
                    .update({ current_file_id: fileRecord.id })
                    .eq('id', productId);

                if (productUpdateError) throw productUpdateError;

                setStatus(`Success! ${originalFilename} is now live.`, 'success');
                
                // Reset form
                fileInput.value = '';
                notesInput.value = '';

            } catch (error) {
                console.error("Upload process failed:", error);
                setStatus(`Upload failed: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // Helper function for UI messages
        function setStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = type;
        }

        // Run this on startup
        loadProducts();
    </script>
</body>
</html>